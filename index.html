<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PadelBoard Config (PB2)</title>

  <!-- Tailwind CDN (para que se vea bien en GitHub Pages aunque solo tengas index.html) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- MQTT.js (WebSockets) -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-3xl mx-auto p-4 sm:p-6">
    <div class="flex items-center justify-between gap-3">
      <h1 class="text-2xl sm:text-3xl font-bold">PadelBoard Config</h1>
      <span id="badge"
        class="text-xs px-3 py-1 rounded-full bg-slate-800 text-slate-200 border border-slate-700">
        MQTT: desconectado
      </span>
    </div>

    <p class="mt-2 text-slate-300">
      Esta página publica la configuración del partido a <b>HiveMQ Cloud</b> por MQTT (WSS),
      para que el ESP32 PB2 la reciba desde cualquier red (Internet).
    </p>

    <!-- Ajustes MQTT -->
    <div class="mt-5 p-4 rounded-xl bg-slate-900 border border-slate-800">
      <h2 class="font-semibold text-lg mb-3">Conexión MQTT (Internet)</h2>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div>
          <label class="text-sm text-slate-300">Host (HiveMQ Cloud)</label>
          <input id="mqttHost" class="w-full mt-1 px-3 py-2 rounded bg-slate-950 border border-slate-700"
            value="8710939c545d4dc7adc1804a0bd323fb.s1.eu.hivemq.cloud" />
        </div>

        <div>
          <label class="text-sm text-slate-300">Puerto WSS</label>
          <input id="mqttPort" class="w-full mt-1 px-3 py-2 rounded bg-slate-950 border border-slate-700"
            value="8884" />
          <div class="text-xs text-slate-400 mt-1">En browser se usa WSS (normalmente 8884). Ruta: <code>/mqtt</code></div>
        </div>

        <div>
          <label class="text-sm text-slate-300">Usuario</label>
          <input id="mqttUser" class="w-full mt-1 px-3 py-2 rounded bg-slate-950 border border-slate-700"
            value="padelboard_pb2" />
        </div>

        <div>
          <label class="text-sm text-slate-300">Password</label>
          <input id="mqttPass" type="password" class="w-full mt-1 px-3 py-2 rounded bg-slate-950 border border-slate-700"
            value="Aqeria123" />
        </div>

        <div class="sm:col-span-2">
          <label class="text-sm text-slate-300">Device ID / Topic base</label>
          <input id="deviceId" class="w-full mt-1 px-3 py-2 rounded bg-slate-950 border border-slate-700"
            value="PB2" />
          <div class="text-xs text-slate-400 mt-1">
            Publica a: <code>padelboard/&lt;DeviceId&gt;/config</code> y se suscribe a <code>padelboard/&lt;DeviceId&gt;/state</code>
          </div>
        </div>
      </div>

      <div class="mt-4 flex flex-wrap gap-2">
        <button id="btnConnect"
          class="px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-500 font-semibold">
          Conectar MQTT
        </button>
        <button id="btnDisconnect"
          class="px-4 py-2 rounded bg-slate-700 hover:bg-slate-600 font-semibold">
          Desconectar
        </button>
        <button id="btnTestSub"
          class="px-4 py-2 rounded bg-sky-700 hover:bg-sky-600 font-semibold">
          Suscribirme a state
        </button>
      </div>

      <div class="mt-3 text-sm text-slate-300">
        <div><b>WS URL:</b> <span id="wsUrl" class="text-slate-200"></span></div>
        <div><b>Config topic:</b> <code id="topicConfig"></code></div>
        <div><b>State topic:</b> <code id="topicState"></code></div>
      </div>

      <pre id="log" class="mt-4 p-3 rounded bg-black/40 border border-slate-800 text-xs overflow-auto h-40"></pre>
    </div>

    <!-- Formulario Config -->
    <div class="mt-5 p-4 rounded-xl bg-slate-900 border border-slate-800">
      <h2 class="font-semibold text-lg mb-3">Configurar Partido</h2>

      <form id="cfgForm" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div>
          <label class="text-sm text-slate-300">Equipo A - Jugador 1</label>
          <input id="a_first" class="w-full mt-1 px-3 py-2 rounded bg-slate-950 border border-slate-700" value="JUANITO" />
        </div>
        <div>
          <label class="text-sm text-slate-300">Equipo A - Jugador 2</label>
          <input id="a_last" class="w-full mt-1 px-3 py-2 rounded bg-slate-950 border border-slate-700" value="DAVILA" />
        </div>

        <div>
          <label class="text-sm text-slate-300">Equipo B - Jugador 1</label>
          <input id="b_first" class="w-full mt-1 px-3 py-2 rounded bg-slate-950 border border-slate-700" value="NICO" />
        </div>
        <div>
          <label class="text-sm text-slate-300">Equipo B - Jugador 2</label>
          <input id="b_last" class="w-full mt-1 px-3 py-2 rounded bg-slate-950 border border-slate-700" value="MITI" />
        </div>

        <div>
          <label class="text-sm text-slate-300">Tipo de juego</label>
          <select id="gameType" class="w-full mt-1 px-3 py-2 rounded bg-slate-950 border border-slate-700">
            <option value="3sets" selected>3 sets</option>
            <option value="1set">1 set</option>
            <option value="2sets-super">2 sets + super tiebreak</option>
          </select>
        </div>

        <div>
          <label class="text-sm text-slate-300">Scoring</label>
          <select id="scoring" class="w-full mt-1 px-3 py-2 rounded bg-slate-950 border border-slate-700">
            <option value="golden" selected>Golden point</option>
            <option value="advantage">Ventaja</option>
          </select>
        </div>

        <div>
          <label class="text-sm text-slate-300">Cambio de lado</label>
          <select id="sideChange" class="w-full mt-1 px-3 py-2 rounded bg-slate-950 border border-slate-700">
            <option value="set" selected>Al final de cada set</option>
            <option value="odd">Juegos impares</option>
          </select>
        </div>

        <label class="flex items-center gap-2 mt-2">
          <input id="tournamentMode" type="checkbox" class="w-4 h-4" checked />
          <span class="text-sm text-slate-300">Tournament mode (cambio lado en tiebreak cada 6 puntos)</span>
        </label>

        <div class="sm:col-span-2 mt-3 flex flex-wrap gap-2">
          <button type="submit"
            class="px-4 py-2 rounded bg-indigo-600 hover:bg-indigo-500 font-semibold">
            Publicar Config (MQTT)
          </button>

          <button type="button" id="btnPublishRetain"
            class="px-4 py-2 rounded bg-purple-700 hover:bg-purple-600 font-semibold">
            Publicar Config (retain)
          </button>
        </div>
      </form>

      <div class="mt-3 text-sm text-slate-300">
        <div><b>Último JSON enviado:</b></div>
        <pre id="lastJson" class="mt-2 p-3 rounded bg-black/40 border border-slate-800 text-xs overflow-auto"></pre>
      </div>
    </div>
  </div>

<script>
  let client = null;

  const el = (id) => document.getElementById(id);

  function log(line) {
    const box = el("log");
    box.textContent += line + "\n";
    box.scrollTop = box.scrollHeight;
  }

  function updateTopics() {
    const dev = el("deviceId").value.trim() || "PB2";
    const tCfg = `padelboard/${dev}/config`;
    const tSt  = `padelboard/${dev}/state`;
    el("topicConfig").textContent = tCfg;
    el("topicState").textContent  = tSt;

    const host = el("mqttHost").value.trim();
    const port = el("mqttPort").value.trim();
    el("wsUrl").textContent = `wss://${host}:${port}/mqtt`;
  }

  function setBadge(ok, text) {
    const b = el("badge");
    b.textContent = text;
    b.className =
      "text-xs px-3 py-1 rounded-full border " +
      (ok
        ? "bg-emerald-900/40 text-emerald-200 border-emerald-700"
        : "bg-slate-800 text-slate-200 border-slate-700");
  }

  function connectMQTT() {
    updateTopics();

    const host = el("mqttHost").value.trim();
    const port = parseInt(el("mqttPort").value.trim(), 10) || 8884;
    const user = el("mqttUser").value.trim();
    const pass = el("mqttPass").value;

    const url = `wss://${host}:${port}/mqtt`;

    const clientId = `web-${(Math.random().toString(16).slice(2))}`;

    log(`[WEB] Conectando a ${url}  clientId=${clientId}`);
    setBadge(false, "MQTT: conectando...");

    client = mqtt.connect(url, {
      username: user,
      password: pass,
      clientId,
      clean: true,
      reconnectPeriod: 2000,
      connectTimeout: 8000,
      keepalive: 60,
    });

    client.on("connect", () => {
      log("[WEB] MQTT conectado ✅");
      setBadge(true, "MQTT: conectado");
    });

    client.on("reconnect", () => {
      log("[WEB] MQTT reconectando...");
      setBadge(false, "MQTT: reconectando...");
    });

    client.on("error", (err) => {
      log("[WEB] MQTT error: " + (err?.message || err));
      setBadge(false, "MQTT: error");
    });

    client.on("close", () => {
      log("[WEB] MQTT cerrado");
      setBadge(false, "MQTT: desconectado");
    });

    client.on("message", (topic, payload) => {
      const msg = payload?.toString?.() || "";
      log(`[WEB] RX ${topic}: ${msg}`);
    });
  }

  function disconnectMQTT() {
    if (client) {
      log("[WEB] Cerrando MQTT...");
      client.end(true);
      client = null;
    }
    setBadge(false, "MQTT: desconectado");
  }

  function subscribeState() {
    if (!client || !client.connected) {
      alert("Primero conecta MQTT");
      return;
    }
    const dev = el("deviceId").value.trim() || "PB2";
    const topic = `padelboard/${dev}/state`;
    client.subscribe(topic, { qos: 1 }, (err) => {
      if (err) log("[WEB] SUB error: " + err.message);
      else log("[WEB] SUB OK: " + topic);
    });
  }

  function buildPayload() {
    // claves EXACTAS como tu ESP32 espera (a_first, a_last, b_first, b_last, etc.)
    return {
      a_first: el("a_first").value.trim(),
      a_last: el("a_last").value.trim(),
      b_first: el("b_first").value.trim(),
      b_last: el("b_last").value.trim(),
      gameType: el("gameType").value,
      scoring: el("scoring").value,
      sideChange: el("sideChange").value,
      tournamentMode: el("tournamentMode").checked
    };
  }

  function publishConfig(retain=false) {
    if (!client || !client.connected) {
      alert("MQTT no está conectado. Presiona: Conectar MQTT");
      return;
    }
    const dev = el("deviceId").value.trim() || "PB2";
    const topic = `padelboard/${dev}/config`;
    const payload = buildPayload();
    const msg = JSON.stringify(payload);

    el("lastJson").textContent = msg;

    client.publish(topic, msg, { qos: 1, retain }, (err) => {
      if (err) log("[WEB] PUB error: " + err.message);
      else log(`[WEB] PUB OK -> ${topic} (qos=1 retain=${retain})`);
    });
  }

  // UI bindings
  updateTopics();
  ["mqttHost","mqttPort","deviceId"].forEach(id => {
    el(id).addEventListener("input", updateTopics);
  });

  el("btnConnect").addEventListener("click", connectMQTT);
  el("btnDisconnect").addEventListener("click", disconnectMQTT);
  el("btnTestSub").addEventListener("click", subscribeState);

  el("cfgForm").addEventListener("submit", (e) => {
    e.preventDefault();
    publishConfig(false);
  });

  el("btnPublishRetain").addEventListener("click", () => publishConfig(true));

</script>
</body>
</html>
